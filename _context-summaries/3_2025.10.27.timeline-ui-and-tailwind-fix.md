# Context Summary: Phase 4 - Timeline UI Implementation and Tailwind CSS v4 Fix

**Date:** 2025-10-27  
**Complexity:** Critical  
**Phase:** Phase 4 Complete - Timeline Editor

## Overview

Implemented complete Timeline canvas component with Konva.js, LayerPanel component, and PreviewPlayer placeholder. Fixed critical Tailwind CSS v4 configuration issue that was preventing ALL styling from working. Updated UI layout to match reference design with 4-panel structure.

## Key Files Created

### Components
- `src/components/Timeline/Timeline.tsx` - Konva canvas timeline with draggable clips
- `src/components/Timeline/LayerPanel.tsx` - Lists all clips on timeline
- `src/components/Preview/PreviewPlayer.tsx` - Thumbnail preview placeholder

### Configuration
- `vite.config.ts` - Added @tailwindcss/vite plugin (CRITICAL)
- `package.json` - Added @tailwindcss/vite dependency

### Modified
- `src/App.tsx` - 4-panel layout with proper flex constraints
- `src/components/MediaLibrary/MediaLibrary.tsx` - Auto-add clips to timeline, simplified UI
- `memory-bank/activeContext.md` - Updated to Phase 4 complete
- `memory-bank/progress.md` - Updated completion to 45%

### Deleted
- `src/tailwindcss` - Empty file that was blocking Tailwind imports

## Critical Discovery: Tailwind CSS v4 Configuration

### The Problem
Tailwind CSS was **completely not working** - NO styles were being applied at all. The issue had two parts:

1. **Empty File Blocking Imports**: An empty file `src/tailwindcss` existed, causing `@import "tailwindcss"` in App.css to resolve to this empty file instead of the npm package
2. **Missing Vite Plugin**: Tailwind CSS v4 requires `@tailwindcss/vite` plugin to process the `@import "tailwindcss"` statement

### The Solution
```bash
# Install required plugin
npm install -D @tailwindcss/vite

# Delete blocking file
rm src/tailwindcss

# Update vite.config.ts
import tailwindcss from "@tailwindcss/vite";
export default defineConfig(async () => ({
  plugins: [react(), tailwindcss()],  // Added tailwindcss()
}));
```

### Key Learning
**Tailwind CSS v4 is fundamentally different from v3:**
- v4 uses `@import "tailwindcss"` in CSS files
- v4 requires `@tailwindcss/vite` plugin (NOT PostCSS plugin)
- PostCSS config should ONLY have `autoprefixer: {}`
- The `@import` statement must resolve to the npm package, not a local file

## Timeline Component Implementation

### Features Implemented
```typescript
// Timeline.tsx structure
- Konva Stage with responsive width
- Time ruler with second markers (changes based on zoom)
- Track backgrounds with left label panel (120px)
- Draggable clip rectangles (blue with labels)
- Red playhead with triangle indicator
- Zoom controls (10-200 px/s)
- Horizontal scroll for long timelines
```

### Coordinate Conversion
```typescript
const timeToX = (time: number) => time * zoom;
const xToTime = (x: number) => x / zoom;
```

### Clip Dragging
```typescript
// Clips are draggable Konva Rects
// On drag end: calculate new startTime, update store
const handleDragEnd = (e: any) => {
  const newX = e.target.x();
  const newStartTime = newX / zoom;
  updateClip(clip.id, { startTime: Math.max(0, newStartTime) });
  e.target.x(x); // Reset (store update re-renders)
};
```

## LayerPanel Component

Simple list view showing all clips from all tracks:
```typescript
const allClips = tracks.flatMap(track => track.clips);
// Display as black rectangles with clip names
```

## Auto-Add Clips to Timeline

Modified MediaLibrary import handler:
```typescript
importedFiles.forEach(file => {
  addMediaFile(file);
  
  // Auto-add to timeline
  const startTime = lastClip ? lastClip.startTime + lastClip.duration : 0;
  addClip({
    id: uuidv4(),
    mediaFileId: file.id,
    trackId: firstTrack.id,
    startTime,
    duration: file.duration,
    trimStart: 0,
    trimEnd: 0,
    layer: 0
  });
});
```

## Layout Implementation

### 4-Panel Structure
```typescript
// Top Row (flex-1)
<div className="flex-1 flex flex-row overflow-hidden">
  <div id="media-library-panel" className="w-80 flex-shrink-0">
    {/* 320px fixed width */}
  </div>
  <div id="preview-panel" className="flex-1 flex flex-col relative">
    {/* Takes remaining space */}
  </div>
</div>

// Bottom Row (h-64 = 256px)
<div className="h-64 flex flex-row border-t border-gray-700">
  <div id="layer-panel" className="w-80 flex-shrink-0">
    {/* 320px fixed width */}
  </div>
  <div id="timeline-panel" className="flex-1 bg-gray-800 flex flex-col overflow-hidden" style={{ minWidth: 0 }}>
    {/* Takes remaining space */}
  </div>
</div>
```

### Critical Flex Layout Pattern
```typescript
// To prevent overflow in flex layouts:
1. Parent: overflow-hidden
2. Flex child: min-h-0 and min-w-0 (allows shrinking)
3. Fixed-width panels: flex-shrink-0
```

## Preview Player Sizing

Fixed image overflow issue:
```typescript
<div className="preview-player h-full w-full flex flex-col bg-black overflow-hidden">
  <div className="flex-1 flex items-center justify-center p-4 min-h-0 min-w-0">
    <div className="w-full h-full flex flex-col items-center justify-center gap-2">
      <div className="w-full h-full flex items-center justify-center">
        <img
          src={currentMedia.thumbnailUrl}
          className="w-auto h-auto max-w-full max-h-full object-contain"
          style={{ 
            aspectRatio: `${currentMedia.width} / ${currentMedia.height}`
          }}
        />
      </div>
    </div>
  </div>
</div>
```

Key: `min-h-0` and `min-w-0` on flex children allow them to shrink below content size.

## UI Changes

### Media Library
- Simplified from thumbnail cards to list items
- Shows: filename + file size (e.g. "2025-10-27 00-06-48.mp4 | 0.0MB")
- White "+Add Clip" button
- Red "MEDIA LIBRARY" header

### Headers
- Red labels: "MEDIA LIBRARY", "LAYER PANEL", "TIMELINE PANEL"
- No preview panel label (hidden for cleaner look)

## Testing Notes

### Tailwind Test Component
Created `TailwindTest.tsx` with obvious styles to verify Tailwind was working:
- Red background (`bg-red-500`)
- Large text (`text-4xl`)
- Colored boxes (`bg-blue-500`, `bg-green-500`, `bg-yellow-500`)

**Before fix:** Black text on white background (no styles)  
**After fix:** Proper colored styling appeared

## Git Commits

1. `8eb2f9d` - Initial Timeline, LayerPanel, PreviewPlayer, layout changes
2. `62fd8b4` - Fixed Tailwind CSS v4 configuration (critical fix)

## Performance Considerations

- Konva Stage width calculated based on timeline duration
- Responsive width updates on window resize
- Timeline scrolls horizontally when content exceeds container
- No performance issues with canvas rendering at current scale

## Next Steps

**Phase 5: Video Preview**
- Task 5.1: Replace thumbnail with HTML5 video element
- Task 5.2: Sync video playback with timeline playhead
- Implement requestAnimationFrame loop for smooth playback
- Handle clip boundaries and seeking

## Important Patterns for Future Reference

### Tailwind CSS v4 Setup Checklist
- ✅ Install `@tailwindcss/vite`
- ✅ Add `tailwindcss()` to `vite.config.ts` plugins
- ✅ Use `@import "tailwindcss"` in CSS file
- ✅ PostCSS config: ONLY `autoprefixer: {}`
- ✅ No local files named `tailwindcss` in src/

### Flex Overflow Prevention
```typescript
// Parent
className="overflow-hidden"

// Flex child that needs to shrink
className="flex-1 min-h-0 min-w-0"

// Fixed-width sibling
className="w-80 flex-shrink-0"
```

### Konva Clip Dragging
```typescript
// Don't update position directly - update store
onDragEnd={(e) => {
  const newPosition = calculateFromPixels(e.target.x());
  updateStore(newPosition);
  e.target.x(originalX); // Reset, let re-render handle it
}}
```

## Files to Reference

- `_docs/architecture.md` - Module 8 (Timeline Canvas) specification
- `_docs/task-list-mvp.md` - Phase 4 tasks (4.1-4.3)
- `vite.config.ts` - Tailwind plugin configuration
- `src/components/Timeline/Timeline.tsx` - Konva implementation
- `src/App.tsx` - 4-panel layout structure

## Conclusion

Phase 4 complete with fully functional timeline editor UI. Critical Tailwind CSS v4 configuration issue resolved, enabling all styling to work correctly. UI now matches reference design with proper panel layout and responsive sizing. Ready to proceed with video playback implementation in Phase 5.

