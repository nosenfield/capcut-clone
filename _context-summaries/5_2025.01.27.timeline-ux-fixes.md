# Context Summary: Timeline UX Fixes
**Date:** 2025-01-27  
**Complexity:** Complex

## Overview
Fixed multiple critical UX issues in timeline playback and editing, including playhead navigation, playback continuity, clip trimming, and blob URL management.

## Key Files
- `src/components/Timeline/Timeline.tsx` - Playhead dragging, click-to-seek, trim logic
- `src/components/Preview/PreviewPlayer.tsx` - Playback continuation, blob URL management
- `src/components/MediaLibrary/MediaLibrary.tsx` - Added debugging attributes

## Important Details

### Playhead Navigation Fixes

**Issue**: Playhead was not draggable and clicking didn't move it to correct position.

**Solution**:
- Made playhead draggable using Konva Group with drag handlers
- Fixed position calculation to use current position + drag offset
- Restricted click-to-seek to time ruler area only (top 30px), not track area

**Key Code Pattern**:
```typescript
// Get Group reference (could be Group or child element)
const group = e.target.getType() === 'Group' ? e.target : e.target.getParent();

// Calculate new position accounting for Group offset
const dragOffset = group.x();
const newPosition = Math.max(0, (x + dragOffset) / zoom);
setPlayheadPosition(newPosition);
group.x(0); // Reset Group offset
```

### Playback Continuation Through Gaps

**Issue**: Playback stopped when reaching end of clip, wouldn't continue through gaps.

**Solution**:
- Modified playback logic to advance playhead continuously
- Video pauses when in gaps (no clip), resumes when entering clip
- Only stops at timeline end, not clip end

**Key Code Pattern**:
```typescript
if (currentClip) {
  // In a clip - sync and play video
  videoRef.current.currentTime = actualVideoTime;
  if (videoRef.current.paused) videoRef.current.play();
} else {
  // In a gap - pause video
  if (!videoRef.current.paused) videoRef.current.pause();
}
```

### Clip Trimming Position Fixes

**Issue**: Clips jumped to wrong position when trimming.

**Solution**:
- Left trim: Adjust `startTime` by cloth delta to keep clip visually stable
- Right trim: Only adjust `duration` and `trimEnd`
- Stop event propagation on trim handles to prevent Group movement

**Key Code Pattern**:
```typescript
// Left trim - adjust startTime to prevent jumping
const actualDelta = newTrimStart - clip.trimStart;
const newDuration = clip.duration - actualDelta;
const newStartTime = clip.startTime + actualDelta;
updateClip(clip.id, { trimStart: newTrimStart, duration: newDuration, startTime: newStartTime });

// Stop propagation to prevent Group from moving
e.cancelBubble = true;
e.evt?.stopPropagation();
```

### Blob URL Management

**Issue**: WebKitBlobResource errors when switching between clips or crossing gaps.

**Solution**:
- Track last loaded media path to avoid reloading same video
- Delay blob URL revocation to allow video element to fully load new source
- Keep blob URLs active across gaps instead of revoking immediately

**Key Code Pattern**:
```typescript
// Track last loaded path
const lastMediaPathRef = React.useRef<string | null>(null);

// Don't reload if same media
if (lastMediaPathRef.current === currentMedia.path) {
  if (blobUrlRef.current) setVideoSrc(blobUrlRef.current);
  return;
}

// Delay revocation after loading new source
setTimeout(() => {
  if (oldBlobUrl) URL.revokeObjectURL(oldBlobUrl);
}, 1000);
```

## Testing Notes
- Verify playhead dragging works smoothly
- Test click-to-seek only works in ruler area
- Verify playback continues through gaps without stopping
- Test clip trimming doesn't cause position jumps
- Check no blob URL errors when switching clips

## Next Steps
- Ready to proceed with Phase 7: Export functionality
- All timeline editing features working correctly

