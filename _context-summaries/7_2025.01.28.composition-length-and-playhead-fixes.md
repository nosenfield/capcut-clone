# Context Summary: Composition Length Implementation & Playhead Behavior Fix

**Date:** 2025-01-28  
**Complexity:** Critical

## Overview
Implemented fixed composition length (separate from auto-calculated duration) and fixed playhead behavior to continue through gaps until reaching composition end. Created UX glossary to establish clear terminology.

## Key Files
- `src/store/timelineStore.ts` - Added `compositionLength` state (default 10s)
- `src/hooks/usePlaybackSync.ts` - Updated to use `compositionLength` instead of `duration`
- `src/components/Timeline/Timeline.tsx` - Uses `compositionLength` for rendering
- `src/components/Timeline/TimelineControls.tsx` - Made composition length editable in timestamp display
- `_docs/glossary.md` - Created UX terminology reference

## Important Details

### UX Clarification: Composition vs Duration
**Discovery:** There was confusion about what "duration" meant in the timeline context.

- **Composition Length**: Fixed working area set by user (default 10s). Does NOT change automatically.
- **Duration**: Auto-calculated value representing where the last clip ends. Grows as clips are added.
- **Problem**: Playback was checking against `duration`, causing it to stop at the end of the last clip instead of continuing to the composition end.

### Implementation Changes

#### 1. Timeline Store Updates
- Added `compositionLength: number` state (default: 10 seconds)
- Added `setCompositionLength(length: number)` action with validation (min 1s)
- Kept `duration` for backward compatibility (clip visualization)

#### 2. Playback Sync Fix
**Bug:** Playhead stopped at end of last clip instead of continuing to composition end.

**Solution:**
- Changed `usePlaybackSync` to check `compositionLength` instead of `duration`
- Removed clamping that prevented playhead from advancing past duration
- Added logic to continue advancing with delta time when playhead passes clip end
- Fixed frame timing by capturing `now` at start of each frame and updating `lastFrameTime` at end

**Key Code:**
```typescript
// Check against composition length, not auto-calculated duration
if (currentPos >= compositionLength) {
  setPlayheadPosition(compositionLength);
  setIsPlaying(false);
  return;
}

// When past clip end, continue with delta time
if (newPosition >= clipEndTime) {
  const delta = (now - lastFrameTime) / 1000;
  newPosition = currentPos + delta;
  video.pause(); // Pause video when in gap
}
```

#### 3. Timeline Controls UI
- Made composition length editable directly in the timestamp display
- Shows as: `{playheadPosition}s / [compositionLength input]s`
- Doubled input width from `w-16` to `w-32` for better UX
- Added validation: min 0.1s, max 600s
- Input resets to last valid value on blur if invalid

### Debug Logging
Added comprehensive logging to track playhead transitions:
- Frame updates showing current position, composition length, gap remaining
- Clip playback with video time and offset calculations
- Delta advance transitions when passing clip ends
- Gap advancement tracking

## Testing Notes
- Playhead should now continue smoothly through gaps between clips
- Playhead stops at composition length, not at end of last clip
- Composition length can be edited in real-time via input field
- Timeline ruler shows composition length, not auto-calculated duration
- Frame timing should be consistent without large jumps

## Next Steps
- Test with multiple clips and gaps
- Verify playback stops correctly at composition end
- Consider exporting timeline duration separate from composition length

